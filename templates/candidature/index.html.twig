{# templates/candidature/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Candidatures - Interned{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="{{ asset('css/candidature.css') }}">
    <style>
        /* Styles pour la modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            width: 50%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 10000;
        }
        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .close-modal:hover {
            color: #000;
        }
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-section {
            margin-bottom: 20px;
        }
        .modal-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        .modal-section p {
            color: #34495e;
            line-height: 1.6;
            font-size: 14px;
        }
        .view-btn {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 16px;
            min-width: 40px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e3f2fd;
            border: none;
            cursor: pointer;
            color: #1976d2;
            transition: all 0.2s;
        }
        .view-btn:hover {
            background-color: #1976d2;
            color: white;
            transform: translateY(-1px);
        }
        .note-btn {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 16px;
            min-width: 40px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff3e0;
            border: none;
            cursor: pointer;
            color: #f57c00;
            transition: all 0.2s;
        }
        .note-btn:hover {
            background-color: #f57c00;
            color: white;
            transform: translateY(-1px);
        }
        
        /* Styles pour la modal de notation */
        .rating-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .rating-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 30%;
            max-width: 400px;
            border-radius: 8px;
            position: relative;
        }
        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .rating-star {
            font-size: 30px;
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }
        .rating-star.active {
            color: #f57c00;
        }
        .rating-submit {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #f57c00;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        .rating-submit:hover {
            background-color: #e65100;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="candidatures-container">
        <div class="header">
            <h1>Candidatures</h1>
            <div class="filters">
                <button class="filter-btn accepted">Accept√©es</button>
                <button class="filter-btn pending">En cours</button>
                <button class="filter-btn refused">Refus√©e</button>
            </div>
        </div>

        <div class="main-content">
            <div class="applications-list">
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Rechercher une candidature...">
                    <button class="search-btn">
                        üîç
                    </button>
                </div>
                {% for candidature in candidatures|default([]) %}
                    <div class="application-card"
                         data-lat="{{ candidature.offreDeStage.entreprise.adresse.latitude }}"
                         data-lng="{{ candidature.offreDeStage.entreprise.adresse.longitude }}"
                         data-id="{{ candidature.offreDeStage.id }}"
                         data-title="{{ candidature.offreDeStage.titreOffre }}"
                         data-company="{{ candidature.offreDeStage.entreprise.nom }}"
                         data-description="{{ candidature.offreDeStage.descriptionOffre }}"
                         data-skills="{{ candidature.offreDeStage.competencesRequises }}"
                         data-duration="{{ candidature.offreDeStage.dureeStage }}"
                         data-start-date="{{ candidature.offreDeStage.dateDebutStage|date('d/m/Y') }}"
                         data-end-date="{{ candidature.offreDeStage.dateFinStage|date('d/m/Y') }}"
                         data-salary="{{ candidature.offreDeStage.salaire }}"
                         data-address="{{ candidature.offreDeStage.entreprise.adresse.rue }}, {{ candidature.offreDeStage.entreprise.adresse.ville }}, {{ candidature.offreDeStage.entreprise.adresse.codePostal }}">
                        <div class="application-image">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="application-details">
                            <div class="application-title">{{ candidature.offreDeStage.titreOffre }}</div>
                            <div class="application-description">{{ candidature.offreDeStage.descriptionOffre }}</div>
                            <div class="status-badge {{ candidature.statut|lower }}">
                                {{ candidature.statut }}
                            </div>
                        </div>
                        <div class="application-actions">
                            <button class="view-btn" title="Voir les d√©tails">
                                üëÅÔ∏è
                            </button>
                            {% if candidature.statut == 'Accept√©e' %}
                                <button class="note-btn" title="Noter l'entreprise">
                                    ‚≠ê
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="no-applications">
                        Aucune candidature trouv√©e.
                    </div>
                {% endfor %}
            </div>
            <div id="map"></div>
        </div>
    </div>

    {# Modal pour les d√©tails de l'offre #}
    <div id="offerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <p id="modalCompany"></p>
            </div>
            <div class="modal-section">
                <h3>Description</h3>
                <p id="modalDescription"></p>
            </div>
            <div class="modal-section">
                <h3>Comp√©tences requises</h3>
                <p id="modalSkills"></p>
            </div>
            <div class="modal-section">
                <h3>D√©tails du stage</h3>
                <p id="modalDetails"></p>
            </div>
            <div class="modal-section">
                <h3>Entreprise</h3>
                <p id="modalCompanyDetails"></p>
            </div>
        </div>
    </div>

    {# Modal pour la notation #}
    <div id="ratingModal" class="rating-modal">
        <div class="rating-modal-content">
            <span class="close-modal">&times;</span>
            <h2>Noter l'entreprise</h2>
            <p id="ratingCompanyName"></p>
            <form id="ratingForm" method="POST" action="{{ path('app_note_create') }}">
                <input type="hidden" name="entreprise_id" id="ratingEntrepriseId">
                <div class="rating-stars">
                    <span class="rating-star" data-value="1">‚òÖ</span>
                    <span class="rating-star" data-value="2">‚òÖ</span>
                    <span class="rating-star" data-value="3">‚òÖ</span>
                    <span class="rating-star" data-value="4">‚òÖ</span>
                    <span class="rating-star" data-value="5">‚òÖ</span>
                </div>
                <input type="hidden" name="valeur" id="ratingValue">
                <button type="submit" class="rating-submit">Valider la note</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="{{ asset('js/candidature.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('offerModal');
            const closeModalBtn = document.querySelector('.close-modal');

            // Fonction pour ouvrir la modal avec les d√©tails de l'offre
            function openModal(card) {
                document.getElementById('modalTitle').textContent = card.dataset.title;
                document.getElementById('modalCompany').textContent = card.dataset.company;
                document.getElementById('modalDescription').textContent = card.dataset.description;
                document.getElementById('modalSkills').textContent = card.dataset.skills;

                // Formatage des d√©tails du stage
                var details = `
                    Dur√©e : ${card.dataset.duration} mois<br>
                    Date de d√©but : ${card.dataset.startDate}<br>
                    Date de fin : ${card.dataset.endDate}<br>
                    Salaire : ${card.dataset.salary}‚Ç¨ par mois
                `;
                document.getElementById('modalDetails').innerHTML = details;

                // D√©tails de l'entreprise
                document.getElementById('modalCompanyDetails').innerHTML = `
                    ${card.dataset.company}<br>
                    Adresse : ${card.dataset.address}
                `;

                modal.style.display = 'block';
            }

            // Fonction pour fermer la modal
            function closeModal() {
                modal.style.display = 'none';
            }

            // Fermer la modal en cliquant sur la croix
            closeModalBtn.onclick = closeModal;

            // Fermer la modal en cliquant en dehors
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeModal();
                }
            }

            // Ajouter les √©v√©nements de clic sur les boutons de vue
            document.querySelectorAll('.view-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const card = this.closest('.application-card');
                    openModal(card);
                });
            });

            // Gestion de la modal de notation
            const ratingModal = document.getElementById('ratingModal');
            const ratingStars = document.querySelectorAll('.rating-star');
            const ratingValue = document.getElementById('ratingValue');
            let selectedRating = 0;

            // Fonction pour ouvrir la modal de notation
            function openRatingModal(card) {
                document.getElementById('ratingCompanyName').textContent = card.dataset.company;
                document.getElementById('ratingEntrepriseId').value = card.dataset.id;
                ratingModal.style.display = 'block';
                selectedRating = 0;
                updateStars();
            }

            // Fonction pour fermer la modal de notation
            function closeRatingModal() {
                ratingModal.style.display = 'none';
            }

            // Gestion des √©toiles de notation
            function updateStars() {
                ratingStars.forEach(star => {
                    if (parseInt(star.dataset.value) <= selectedRating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
                ratingValue.value = selectedRating;
            }

            ratingStars.forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.value);
                    updateStars();
                });
            });

            // Fermer la modal en cliquant sur la croix
            document.querySelector('#ratingModal .close-modal').onclick = closeRatingModal;

            // Fermer la modal en cliquant en dehors
            window.onclick = function(event) {
                if (event.target == ratingModal) {
                    closeRatingModal();
                }
            }

            // Ajouter les √©v√©nements de clic sur les boutons de notation
            document.querySelectorAll('.note-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const card = this.closest('.application-card');
                    openRatingModal(card);
                });
            });

            // Gestion de la soumission du formulaire
            document.getElementById('ratingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (selectedRating === 0) {
                    alert('Veuillez s√©lectionner une note');
                    return;
                }

                const formData = new FormData(this);
                formData.append('valeur', selectedRating);
                formData.append('nom_entreprise', document.getElementById('ratingCompanyName').textContent);

                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        closeRatingModal();
                        // Rafra√Æchir la page pour mettre √† jour l'interface
                        window.location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de l\'envoi de votre note');
                });
            });
        });
    </script>
{% endblock %}
